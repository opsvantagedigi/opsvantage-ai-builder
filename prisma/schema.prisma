generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String            @id @default(cuid())
  email                  String            @unique
  name                   String?
  createdAt              DateTime          @default(now())
  image                  String?
  updatedAt              DateTime          @updatedAt
  openProviderHandle     String?           @unique
  aiGenerationsUsed      Int               @default(0)
  sitesPublished         Int               @default(0)
  stripeCurrentPeriodEnd DateTime?         @map("stripe_current_period_end")
  stripeCustomerId       String?           @unique @map("stripe_customer_id")
  stripePriceId          String?           @map("stripe_price_id")
  stripeSubscriptionId   String?           @unique @map("stripe_subscription_id")
  subscriptionStatus     String?           @default("none")
  usageResetDate         DateTime          @default(now())
  accounts               Account[]
  sentInvites            Invitation[]      @relation("SentInvites")
  orders                 Order[]
  sessions               Session[]
  subscriptions          Subscription[]
  foundersClaims         FoundersClaim[]
  ownedWorkspaces        Workspace[]       @relation("WorkspaceOwner")
  workspaces             WorkspaceMember[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Subscription {
  id                   String    @id @default(cuid())
  userId               String
  stripeSubscriptionId String    @unique
  stripePriceId        String
  stripeCustomerId     String
  plan                 String
  status               String
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  canceledAt           DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Project {
  id            String      @id @default(cuid())
  name          String
  subdomain     String?     @unique
  sanityDataset String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  workspaceId   String
  content       Json?
  customDomain  String?     @unique
  published     Boolean     @default(false)
  publishedAt   DateTime?
  aiTasks       AiTask[]
  domains       Domain[]
  onboarding    Onboarding?
  pages         Page[]
  workspace     Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
}

model Domain {
  id        String   @id @default(cuid())
  projectId String
  hostname  String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Onboarding {
  id                       String           @id @default(cuid())
  projectId                String           @unique
  businessName             String?
  industry                 String?
  createdAt                DateTime         @default(now())
  updatedAt                DateTime         @updatedAt
  brandVoice               String?
  businessType             String?
  colorPalette             Json?
  competitors              Json?
  description              String?
  designStyle              String?
  goals                    String?
  status                   OnboardingStatus @default(DRAFT)
  targetAudience           String?
  backgroundTexturePrompts Json?
  fontPairing              Json?
  heroImagePrompts         Json?
  iconSet                  Json?
  layoutRecommendations    Json?
  project                  Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model AiTask {
  id        String   @id @default(cuid())
  projectId String
  type      TaskType
  status    Status   @default(PENDING)
  provider  Provider @default(GEMINI)
  payload   Json
  result    Json?
  error     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Page {
  id             String    @id @default(cuid())
  projectId      String
  title          String
  slug           String
  type           PageType  @default(CUSTOM)
  isHome         Boolean   @default(false)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  seoDescription String?
  seoTitle       String?
  project        Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sections       Section[]

  @@unique([projectId, slug])
}

model Section {
  id        String      @id @default(cuid())
  pageId    String
  type      SectionType @default(CUSTOM)
  variant   String?
  data      Json
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  order     Int         @default(0)
  page      Page        @relation(fields: [pageId], references: [id], onDelete: Cascade)
}

model Workspace {
  id                     String            @id @default(cuid())
  name                   String
  slug                   String            @unique
  ownerId                String
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt
  type                   WorkspaceType     @default(STANDARD)
  plan                   Plan              @default(FREE)
  stripeCurrentPeriodEnd DateTime?         @map("stripe_current_period_end")
  stripeCustomerId       String?           @unique @map("stripe_customer_id")
  stripePriceId          String?           @map("stripe_price_id")
  stripeSubscriptionId   String?           @unique @map("stripe_subscription_id")
  brandingColors         Json?
  brandingLogo           String?
  customDashboardDomain  String?
  managedClients         AgencyClient[]    @relation("AgencyRelation")
  managedByAgencies      AgencyClient[]    @relation("ClientRelation")
  auditLogs              AuditLog[]
  invitations            Invitation[]
  projects               Project[]
  usage                  Usage?
  owner                  User              @relation("WorkspaceOwner", fields: [ownerId], references: [id])
  members                WorkspaceMember[]

  @@index([ownerId])
}

model WorkspaceMember {
  id          String    @id @default(cuid())
  workspaceId String
  userId      String
  role        Role      @default(VIEWER)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
}

model Invitation {
  id          String    @id @default(cuid())
  token       String    @unique
  email       String
  role        Role      @default(VIEWER)
  expiresAt   DateTime
  workspaceId String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  inviterId   String
  status      String    @default("PENDING")
  inviter     User      @relation("SentInvites", fields: [inviterId], references: [id], onDelete: Cascade)
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([email, workspaceId])
  @@index([workspaceId])
  @@index([inviterId])
}

model AgencyClient {
  id        String             @id @default(cuid())
  agencyId  String
  clientId  String
  status    AgencyClientStatus @default(PENDING)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  agency    Workspace          @relation("AgencyRelation", fields: [agencyId], references: [id], onDelete: Cascade)
  client    Workspace          @relation("ClientRelation", fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([agencyId, clientId])
}

model Order {
  id                   String   @id @default(cuid())
  userId               String
  productId            String
  productType          String
  status               String   @default("PENDING")
  priceAmount          Float
  priceCurrency        String
  nowPaymentsInvoiceId String?  @unique
  openProviderOrderId  String?  @unique
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User     @relation(fields: [userId], references: [id])
}

model AuditLog {
  id          String      @id @default(cuid())
  workspaceId String
  actorId     String
  action      String
  metadata    Json?
  createdAt   DateTime    @default(now())
  entityId    String
  entityType  AuditEntity
  ipAddress   String?
  userAgent   String?
  workspace   Workspace   @relation(fields: [workspaceId], references: [id])

  @@index([workspaceId])
  @@index([actorId])
}

model Usage {
  id             String    @id @default(cuid())
  workspaceId    String    @unique
  aiTokensUsed   Int       @default(0)
  pagesGenerated Int       @default(0)
  month          DateTime  @default(now())
  workspace      Workspace @relation(fields: [workspaceId], references: [id])
}

model LaunchLead {
  id        String   @id @default(cuid())
  email     String   @unique
  source    String?
  createdAt DateTime @default(now())
  notified  Boolean  @default(false)
}

model EarlyAccessSignup {
  id         String   @id @default(cuid())
  email      String   @unique
  signedUpAt DateTime @default(now())
  notified   Boolean  @default(false)
}

model FoundersClaim {
  id              String   @id @default(cuid())
  offerId         String
  fingerprint     String
  userId          String?
  awardedOfferId  String?
  competitorPrice Float?
  zenithPrice     Float?
  savedAmount     Float?
  currency        String   @default("USD")
  createdAt       DateTime @default(now())
  user            User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@unique([offerId, fingerprint])
  @@index([offerId, createdAt])
  @@index([userId, createdAt])
}

model MarzMemory {
  id        String   @id @default(cuid())
  userId    String?
  insight   String
  category  String
  createdAt DateTime @default(now())

  @@index([userId])
}

enum Status {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum OnboardingStatus {
  DRAFT
  COMPLETED
}

enum TaskType {
  ONBOARDING_TO_SITEMAP
  SITEMAP_TO_PAGES
  PAGE_TO_SECTIONS
  GENERATE_COPY
}

enum Provider {
  GEMINI
  OPENAI
}

enum PageType {
  HOME
  LANDING
  CUSTOM
}

enum SectionType {
  HERO
  FEATURES
  TESTIMONIALS
  FAQ
  CUSTOM
  FOOTER
}

enum Role {
  OWNER
  ADMIN
  EDITOR
  VIEWER
}

enum Plan {
  FREE
  PRO
  AGENCY
}

enum WorkspaceType {
  STANDARD
  AGENCY
}

enum AgencyClientStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum AuditEntity {
  PAGE
  PROJECT
  WORKSPACE
  MEMBER
  DOMAIN
  AI_TASK
}
